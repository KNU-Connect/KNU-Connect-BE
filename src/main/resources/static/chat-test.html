<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>KNU-Connect ì±„íŒ… í…ŒìŠ¤íŠ¸</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 50px auto;
            padding: 20px;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .section {
            margin-bottom: 20px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: white;
        }
        .full-width {
            grid-column: 1 / -1;
        }
        h2 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
            margin-top: 0;
        }
        input, button, select {
            padding: 10px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        button.danger {
            background-color: #f44336;
        }
        button.danger:hover {
            background-color: #da190b;
        }
        button.warning {
            background-color: #ff9800;
        }
        button.warning:hover {
            background-color: #e68900;
        }
        #messages {
            height: 400px;
            overflow-y: scroll;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #f9f9f9;
        }
        .message {
            padding: 8px;
            margin: 5px 0;
            border-radius: 5px;
            background-color: white;
        }
        .message.my-message {
            background-color: #e3f2fd;
            text-align: right;
        }
        .message.other-message {
            background-color: #f5f5f5;
        }
        .error {
            color: red;
            background-color: #ffe6e6;
        }
        .unread-notification {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
            font-weight: bold;
        }
        .connected {
            background-color: #d4edda;
            color: #155724;
        }
        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        .active {
            background-color: #cfe2ff;
            color: #084298;
        }
        .badge {
            display: inline-block;
            padding: 3px 8px;
            background-color: #dc3545;
            color: white;
            border-radius: 10px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 5px;
        }
        .info-box {
            background-color: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
        }
        pre {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
        .input-group {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        .input-group label {
            min-width: 100px;
            font-weight: bold;
        }
        .input-group input {
            flex: 1;
        }
    </style>
</head>
<body>
<h1>ğŸš€ KNU-Connect ì±„íŒ… í…ŒìŠ¤íŠ¸</h1>

<div class="section full-width">
    <h2>ğŸ“‹ ì‚¬ìš© ê°€ì´ë“œ</h2>
    <div class="info-box">
        <strong>í…ŒìŠ¤íŠ¸ ìˆœì„œ:</strong>
        <ol>
            <li>JWT í† í°ê³¼ ì±„íŒ…ë°© IDë¥¼ ì…ë ¥í•˜ê³  <strong>ì—°ê²°</strong> ë²„íŠ¼ í´ë¦­</li>
            <li><strong>ì±„íŒ…ë°© ì—´ê¸°</strong> ë²„íŠ¼ìœ¼ë¡œ ì±„íŒ…ë°© í™œì„±í™” (ìë™ ì½ìŒ ì²˜ë¦¬)</li>
            <li>ë©”ì‹œì§€ ì „ì†¡ ë° ìˆ˜ì‹  í…ŒìŠ¤íŠ¸</li>
            <li><strong>ì±„íŒ…ë°© ë‹«ê¸°</strong> í›„ ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ë©”ì‹œì§€ ë³´ë‚´ë©´ ì•ˆì½ì€ ìˆ˜ ì•Œë¦¼ ìˆ˜ì‹ </li>
            <li>ì±„íŒ…ë°© ëª©ë¡ ì¡°íšŒë¡œ unread_count í™•ì¸</li>
        </ol>
    </div>
</div>

<div class="container">
    <div class="section">
        <h2>1ï¸âƒ£ ì—°ê²° ì„¤ì •</h2>
        <div class="input-group">
            <label>JWT í† í°:</label>
            <input type="text" id="token" placeholder="Access Token">
        </div>
        <div class="input-group">
            <label>ì±„íŒ…ë°© ID:</label>
            <input type="number" id="chatRoomId" placeholder="Chat Room ID" value="1">
        </div>
        <div>
            <button onclick="connect()">ğŸ”Œ ì—°ê²°</button>
            <button onclick="disconnect()" class="danger">ğŸ”Œ ì—°ê²° í•´ì œ</button>
        </div>
        <div id="connectionStatus" class="status disconnected">âŒ ì—°ê²° ì•ˆë¨</div>
    </div>

    <div class="section">
        <h2>2ï¸âƒ£ ì±„íŒ…ë°© í™œë™ ê´€ë¦¬</h2>
        <div>
            <button onclick="openChatRoom()" id="openBtn" disabled>ğŸ“– ì±„íŒ…ë°© ì—´ê¸°</button>
            <button onclick="closeChatRoom()" id="closeBtn" disabled class="danger">ğŸ“• ì±„íŒ…ë°© ë‹«ê¸°</button>
        </div>
        <div id="activityStatus" class="status disconnected">ì±„íŒ…ë°© ë‹«í˜</div>
        <div class="info-box">
            <strong>í˜„ì¬ ìƒíƒœ:</strong>
            <div id="activityInfo">ì±„íŒ…ë°©ì„ ë¨¼ì € ì—¬ì„¸ìš”</div>
        </div>
    </div>

    <div class="section full-width">
        <h2>3ï¸âƒ£ ë©”ì‹œì§€ ì „ì†¡</h2>
        <div style="display: flex; gap: 10px;">
            <input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ ì…ë ¥" style="flex: 1;">
            <button onclick="sendMessage()" id="sendBtn" disabled>ğŸ“¤ ì „ì†¡</button>
        </div>
    </div>

    <div class="section">
        <h2>4ï¸âƒ£ REST API í…ŒìŠ¤íŠ¸</h2>
        <button onclick="getChatRoomList()">ğŸ“‹ ì±„íŒ…ë°© ëª©ë¡</button>
        <button onclick="getChatHistory()">ğŸ“œ ì±„íŒ… ê¸°ë¡</button>
        <button onclick="createChatRoom()">â• ì±„íŒ…ë°© ìƒì„±</button>
        <div style="margin-top: 10px;">
            <label>ìƒëŒ€ë°© ID:</label>
            <input type="number" id="participantId" placeholder="ìƒëŒ€ë°© ID" style="width: 120px;">
        </div>
        <div style="margin-top: 10px;">
            <label>ì»¤ì„œ:</label>
            <input type="number" id="cursorInput" placeholder="ì„ íƒì‚¬í•­" style="width: 120px;">
            <label>ì‚¬ì´ì¦ˆ:</label>
            <input type="number" id="sizeInput" placeholder="20" value="20" style="width: 80px;">
        </div>
    </div>

    <div class="section">
        <h2>5ï¸âƒ£ ì•ˆì½ì€ ë©”ì‹œì§€</h2>
        <div id="unreadCount" class="status disconnected">
            ì•ˆì½ì€ ë©”ì‹œì§€: <span id="unreadNumber">0</span>ê°œ
        </div>
        <div class="info-box">
            <strong>ğŸ’¡ íŒ:</strong>
            <ul style="margin: 5px 0; padding-left: 20px;">
                <li>ì±„íŒ…ë°©ì„ ë‹«ì€ í›„ ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ë©´ ì•ˆì½ì€ ìˆ˜ê°€ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤</li>
                <li>ì±„íŒ…ë°©ì„ ì—´ë©´ ìë™ìœ¼ë¡œ ëª¨ë“  ë©”ì‹œì§€ê°€ ì½ìŒ ì²˜ë¦¬ë©ë‹ˆë‹¤</li>
            </ul>
        </div>
    </div>
</div>

<div class="section full-width">
    <h2>6ï¸âƒ£ ë©”ì‹œì§€ ë° ì•Œë¦¼</h2>
    <button onclick="clearMessages()">ğŸ—‘ï¸ ë©”ì‹œì§€ ì§€ìš°ê¸°</button>
    <div id="messages"></div>
</div>

<script>
    let stompClient = null;
    let currentChatRoomId = null;
    let refreshInterval = null;
    let isChatRoomOpen = false;
    let accessToken = null;

    function connect() {
        const token = document.getElementById('token').value;
        const chatRoomId = document.getElementById('chatRoomId').value;

        if (!token) {
            alert('JWT í† í°ì„ ì…ë ¥í•˜ì„¸ìš”!');
            return;
        }

        if (!chatRoomId) {
            alert('ì±„íŒ…ë°© IDë¥¼ ì…ë ¥í•˜ì„¸ìš”!');
            return;
        }

        accessToken = token;
        currentChatRoomId = chatRoomId;

        const socket = new SockJS('http://localhost:8080/ws');
        stompClient = Stomp.over(socket);

        stompClient.connect(
            { Authorization: 'Bearer ' + token },
            function (frame) {
                console.log('Connected: ' + frame);
                updateConnectionStatus(true);

                // ì±„íŒ…ë°© ë©”ì‹œì§€ êµ¬ë…
                stompClient.subscribe('/topic/chat-rooms/' + chatRoomId, function (message) {
                    const data = JSON.parse(message.body);
                    showChatMessage(data);
                });

                // ì±„íŒ…ë°© ì—…ë°ì´íŠ¸ êµ¬ë… (ë©”ì‹œì§€ ì‚­ì œ)
                stompClient.subscribe('/topic/chat-rooms/' + chatRoomId + '/updates', function (message) {
                    showMessage('ì—…ë°ì´íŠ¸', JSON.parse(message.body));
                });

                // ì•ˆì½ì€ ë©”ì‹œì§€ ìˆ˜ êµ¬ë…
                stompClient.subscribe('/user/queue/chat-rooms/' + chatRoomId + '/unread', function (message) {
                    const data = JSON.parse(message.body);
                    updateUnreadCount(data.unread_count);
                    showUnreadNotification(data);
                });

                // ì—ëŸ¬ êµ¬ë…
                stompClient.subscribe('/user/queue/errors', function (message) {
                    showError(JSON.parse(message.body));
                });

                showSystemMessage('WebSocket ì—°ê²° ì„±ê³µ! ì±„íŒ…ë°© ' + chatRoomId + 'ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.');

                // ë²„íŠ¼ í™œì„±í™”
                document.getElementById('openBtn').disabled = false;
                document.getElementById('closeBtn').disabled = false;
                document.getElementById('sendBtn').disabled = false;
            },
            function (error) {
                console.error('Connection error:', error);
                updateConnectionStatus(false);
                showError({ type: 'CONNECTION_ERROR', message: 'ì—°ê²° ì‹¤íŒ¨: ' + error, code: 'ERROR' });
            }
        );
    }

    function disconnect() {
        if (isChatRoomOpen) {
            closeChatRoom();
        }

        if (stompClient !== null) {
            stompClient.disconnect();
            updateConnectionStatus(false);
            showSystemMessage('WebSocket ì—°ê²°ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.');

            // ë²„íŠ¼ ë¹„í™œì„±í™”
            document.getElementById('openBtn').disabled = true;
            document.getElementById('closeBtn').disabled = true;
            document.getElementById('sendBtn').disabled = true;
        }
    }

    function openChatRoom() {
        if (stompClient === null || !stompClient.connected) {
            alert('ë¨¼ì € WebSocketì— ì—°ê²°í•˜ì„¸ìš”!');
            return;
        }

        stompClient.send('/app/chat-rooms/' + currentChatRoomId + '/open', {}, '');
        isChatRoomOpen = true;

        // 1ë¶„ë§ˆë‹¤ í™œë™ ê°±ì‹ 
        refreshInterval = setInterval(() => {
            if (isChatRoomOpen) {
                stompClient.send('/app/chat-rooms/' + currentChatRoomId + '/refresh', {}, '');
                console.log('í™œë™ ê°±ì‹ ë¨');
            }
        }, 60000);

        updateActivityStatus(true);
        showSystemMessage('âœ… ì±„íŒ…ë°©ì´ ì—´ë ¸ìŠµë‹ˆë‹¤. ëª¨ë“  ë©”ì‹œì§€ê°€ ì½ìŒ ì²˜ë¦¬ë©ë‹ˆë‹¤.');
        updateUnreadCount(0);
    }

    function closeChatRoom() {
        if (stompClient === null || !stompClient.connected) {
            alert('ë¨¼ì € WebSocketì— ì—°ê²°í•˜ì„¸ìš”!');
            return;
        }

        stompClient.send('/app/chat-rooms/' + currentChatRoomId + '/close', {}, '');
        isChatRoomOpen = false;

        // ê°±ì‹  íƒ€ì´ë¨¸ ì •ë¦¬
        if (refreshInterval) {
            clearInterval(refreshInterval);
            refreshInterval = null;
        }

        updateActivityStatus(false);
        showSystemMessage('âŒ ì±„íŒ…ë°©ì´ ë‹«í˜”ìŠµë‹ˆë‹¤. ìƒˆ ë©”ì‹œì§€ëŠ” ì•ˆì½ìŒìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.');
    }

    function sendMessage() {
        if (stompClient === null || !stompClient.connected) {
            alert('ë¨¼ì € ì—°ê²°í•˜ì„¸ìš”!');
            return;
        }

        const messageContent = document.getElementById('messageInput').value;
        if (!messageContent) {
            alert('ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”!');
            return;
        }

        stompClient.send(
            '/app/chat-rooms/' + currentChatRoomId + '/chats',
            {},
            JSON.stringify({ content: messageContent })
        );

        document.getElementById('messageInput').value = '';
    }

    async function getChatRoomList() {
        if (!accessToken) {
            alert('ë¨¼ì € ì—°ê²°í•˜ì„¸ìš”!');
            return;
        }

        try {
            const response = await fetch('http://localhost:8080/api/chat-rooms', {
                headers: {
                    'Authorization': 'Bearer ' + accessToken
                }
            });

            if (!response.ok) {
                throw new Error('HTTP error! status: ' + response.status);
            }

            const data = await response.json();
            showMessage('ì±„íŒ…ë°© ëª©ë¡', data);
        } catch (error) {
            showError({ type: 'API_ERROR', message: 'ì±„íŒ…ë°© ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: ' + error.message });
        }
    }

    async function getChatHistory() {
        if (!accessToken || !currentChatRoomId) {
            alert('ë¨¼ì € ì—°ê²°í•˜ì„¸ìš”!');
            return;
        }

        const cursor = document.getElementById('cursorInput').value;
        const size = document.getElementById('sizeInput').value || '20';
        
        let url = `http://localhost:8080/api/chat-rooms/${currentChatRoomId}?size=${size}`;
        if (cursor) {
            url += `&cursor=${cursor}`;
        }

        try {
            const response = await fetch(url, {
                headers: {
                    'Authorization': 'Bearer ' + accessToken
                }
            });

            if (!response.ok) {
                throw new Error('HTTP error! status: ' + response.status);
            }

            const data = await response.json();
            showMessage('ì±„íŒ… ê¸°ë¡', data);
            
            // nextCursorê°€ ìˆìœ¼ë©´ ì»¤ì„œ ì…ë ¥ë€ì— ìë™ ì„¤ì •
            if (data.nextCursor) {
                document.getElementById('cursorInput').value = data.nextCursor;
                showSystemMessage(`ë‹¤ìŒ í˜ì´ì§€ë¥¼ ë³´ë ¤ë©´ "ğŸ“œ ì±„íŒ… ê¸°ë¡" ë²„íŠ¼ì„ ë‹¤ì‹œ í´ë¦­í•˜ì„¸ìš”. (nextCursor: ${data.nextCursor})`);
            } else {
                showSystemMessage('ë§ˆì§€ë§‰ í˜ì´ì§€ì…ë‹ˆë‹¤.');
            }
        } catch (error) {
            showError({ type: 'API_ERROR', message: 'ì±„íŒ… ê¸°ë¡ ì¡°íšŒ ì‹¤íŒ¨: ' + error.message });
        }
    }

    async function createChatRoom() {
        if (!accessToken) {
            alert('ë¨¼ì € ì—°ê²°í•˜ì„¸ìš”!');
            return;
        }

        const participantId = document.getElementById('participantId').value;
        if (!participantId) {
            alert('ìƒëŒ€ë°© IDë¥¼ ì…ë ¥í•˜ì„¸ìš”!');
            return;
        }

        try {
            const response = await fetch('http://localhost:8080/api/chat-rooms', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + accessToken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ participant_id: parseInt(participantId) })
            });

            if (!response.ok) {
                throw new Error('HTTP error! status: ' + response.status);
            }

            const data = await response.json();
            showMessage('ì±„íŒ…ë°© ìƒì„±', data);
            alert('ì±„íŒ…ë°©ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤! ID: ' + data.chat_room_id);
        } catch (error) {
            showError({ type: 'API_ERROR', message: 'ì±„íŒ…ë°© ìƒì„± ì‹¤íŒ¨: ' + error.message });
        }
    }

    function showChatMessage(data) {
        const messagesDiv = document.getElementById('messages');
        const messageElement = document.createElement('div');
        messageElement.className = 'message';

        const time = new Date(data.created_at).toLocaleTimeString('ko-KR');
        let content = `<strong>${data.sender_name}</strong> <small>(${time})</small><br>`;
        content += `${data.content}`;

        messageElement.innerHTML = content;
        messagesDiv.appendChild(messageElement);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function showMessage(type, data) {
        const messagesDiv = document.getElementById('messages');
        const messageElement = document.createElement('div');
        messageElement.className = 'message';

        let content = '<strong>[' + type + ']</strong><br>';
        content += '<pre>' + JSON.stringify(data, null, 2) + '</pre>';

        messageElement.innerHTML = content;
        messagesDiv.appendChild(messageElement);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function showSystemMessage(text) {
        const messagesDiv = document.getElementById('messages');
        const messageElement = document.createElement('div');
        messageElement.className = 'message';
        messageElement.style.backgroundColor = '#e3f2fd';
        messageElement.innerHTML = '<strong>[ì‹œìŠ¤í…œ]</strong><br>' + text;
        messagesDiv.appendChild(messageElement);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function showUnreadNotification(data) {
        const messagesDiv = document.getElementById('messages');
        const messageElement = document.createElement('div');
        messageElement.className = 'message unread-notification';

        let content = '<strong>ğŸ”” ì•ˆì½ì€ ë©”ì‹œì§€ ì•Œë¦¼</strong><br>';
        content += `ì±„íŒ…ë°© ${data.chat_room_id}: <strong>${data.unread_count}ê°œ</strong>ì˜ ì•ˆì½ì€ ë©”ì‹œì§€`;

        messageElement.innerHTML = content;
        messagesDiv.appendChild(messageElement);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function showError(error) {
        const messagesDiv = document.getElementById('messages');
        const messageElement = document.createElement('div');
        messageElement.className = 'message error';

        let content = '<strong>âŒ [ì—ëŸ¬]</strong><br>';
        content += '<pre>' + JSON.stringify(error, null, 2) + '</pre>';

        messageElement.innerHTML = content;
        messagesDiv.appendChild(messageElement);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function clearMessages() {
        document.getElementById('messages').innerHTML = '';
    }

    function updateConnectionStatus(connected) {
        const statusDiv = document.getElementById('connectionStatus');
        if (connected) {
            statusDiv.textContent = 'âœ… WebSocket ì—°ê²°ë¨';
            statusDiv.className = 'status connected';
        } else {
            statusDiv.textContent = 'âŒ ì—°ê²° ì•ˆë¨';
            statusDiv.className = 'status disconnected';
        }
    }

    function updateActivityStatus(isOpen) {
        const statusDiv = document.getElementById('activityStatus');
        const infoDiv = document.getElementById('activityInfo');

        if (isOpen) {
            statusDiv.textContent = 'ğŸ“– ì±„íŒ…ë°© ì—´ë¦¼ (í™œì„±)';
            statusDiv.className = 'status active';
            infoDiv.innerHTML = 'âœ… ë©”ì‹œì§€ ìë™ ì½ìŒ ì²˜ë¦¬ ì¤‘<br>ğŸ”„ 1ë¶„ë§ˆë‹¤ í™œë™ ê°±ì‹  ì¤‘';
        } else {
            statusDiv.textContent = 'ğŸ“• ì±„íŒ…ë°© ë‹«í˜ (ë¹„í™œì„±)';
            statusDiv.className = 'status disconnected';
            infoDiv.innerHTML = 'âš ï¸ ìƒˆ ë©”ì‹œì§€ëŠ” ì•ˆì½ìŒìœ¼ë¡œ í‘œì‹œë¨';
        }
    }

    function updateUnreadCount(count) {
        const unreadDiv = document.getElementById('unreadCount');
        const unreadNumber = document.getElementById('unreadNumber');

        unreadNumber.textContent = count;

        if (count > 0) {
            unreadDiv.className = 'status';
            unreadDiv.style.backgroundColor = '#fff3cd';
            unreadDiv.style.color = '#856404';
        } else {
            unreadDiv.className = 'status connected';
        }
    }

    // Enter í‚¤ë¡œ ë©”ì‹œì§€ ì „ì†¡
    document.getElementById('messageInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    // í˜ì´ì§€ ì´íƒˆ ì‹œ ì±„íŒ…ë°© ë‹«ê¸°
    window.addEventListener('beforeunload', function() {
        if (isChatRoomOpen) {
            closeChatRoom();
        }
    });
</script>
</body>
</html>
